<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>weep.me text</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{font-family:sans-serif;background:#dec;color:#111;padding-top:170px;padding-bottom:48px;min-height:100vh;}
    header{
      position:fixed;top:0;left:0;right:0;z-index:10;
      background:#fffefee6;border-bottom:1px solid #cdcdfe;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      box-shadow:0 2px 8px #b4b4dc09;
      min-height:170px;max-height:170px;
      transition:all .18s;
    }
    .header-content{width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
    .header-title-5{
      flex:1;display:flex;align-items:center;justify-content:center;
      height:140px;min-height:140px;max-height:140px;
      font-size:2.15rem;font-weight:bold;letter-spacing:.04em;line-height:1.3;color:#333;
      word-break:break-all;
    }
    .header-title-2{
      margin-top:18px;
      font-size:1.38rem;font-weight:bold;letter-spacing:.04em;line-height:1.25;color:#333;
      min-height:52px;max-height:52px;display:flex;align-items:center;justify-content:center;
      word-break:break-all;
    }
    .header-epnum{
      font-size:1.1rem;font-weight:normal;color:#222;margin:0 auto 0.3em;
      min-height:30px;max-height:30px;display:flex;align-items:center;justify-content:center;
      letter-spacing: .12em;
    }
    .nav-row{
      width:100%;display:flex;justify-content:center;align-items:center;
      font-size:1rem;margin-top:0;gap:0;
    }
    .nav-btn, .nav-row span.nav-btn{
      background:none;border:none;padding:0 8px;color:#555;cursor:pointer;font-size:1.01em;border-radius:4px;
      transition:.13s;text-decoration:none;margin:0 2px;height:2.1em;display:inline-flex;align-items:center;justify-content:center;
    }
    .nav-btn:disabled,.nav-btn[disabled],.nav-row span.nav-btn[tabindex="-1"]{opacity:.32;cursor:default;}
    .nav-btn:hover:not(:disabled), .nav-btn:focus:not(:disabled){background:#f3e4f8;color:#c140a2;}
    main{display:flex;justify-content:center;}
    .box{max-width:900px;width:100%;margin:22px 0 18px;background:#fff;border:4px solid #cdcdfe;border-radius:7px;padding:12px 12px 22px;min-height:280px;}
    .container{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;}
    @media(min-width:600px){.container{grid-template-columns:repeat(3,1fr);}}
    @media(min-width:900px){.container{grid-template-columns:repeat(4,1fr);}
    .header-title-5{font-size:2.5rem;}
    }
    .link{display:flex;flex-direction:column;align-items:center;cursor:pointer;}
    .link img{width:44px;height:44px;border-radius:4px;object-fit:cover;margin-bottom:2px;}
    .title{font-size:.86rem;font-weight:bold;}
    .subtitle{font-size:.71rem;color:#666;}
    .ep-list{display:flex;flex-wrap:wrap;gap:9px;margin:18px 0;}
    .ep-link{font-size:.97rem;color:#31418a;background:#f6f6fa;border:1.3px solid #cdcdfe;border-radius:15px;padding:3px 14px;margin:0;text-decoration:none;cursor:pointer;min-width:2.5em;transition:.12s;}
    .ep-link.selected,.ep-link:hover{background:#f3e4f8;color:#c140a2;border-color:#cdb0ea;}
    .novel-area{font-size:1.03rem;max-width:640px;margin:18px auto;line-height:1.8;padding:0 10px;}
    .novel-area p{margin:0 0 1.1em;}
    .back-row{display:flex;justify-content:center;margin-bottom:8px;}
    .back-btn{font-size:.97rem;color:#31418a;background:none;border:none;cursor:pointer;padding:2px 11px;border-radius:4px;transition:.13s;}
    .back-btn:hover{background:#f3e4f8;color:#c140a2;}
    .arrow{font-size:1.1em;margin-right:2px;}
    .novel-desc{font-size:.88rem;color:#555;margin-bottom:8px;}
    footer{position:fixed;left:0;right:0;bottom:0;height:48px;background:#fffefee8;border-top:1px solid #cdcdfe;z-index:9;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    footer small{font-size:.83rem;color:#555;line-height:1.3;}
    #version{font-size:.7rem;color:#888;}
    @media(max-width:600px){
      .header-title-5{font-size:1.3rem;height:88px;min-height:88px;max-height:88px;}
      header{min-height:90px;max-height:90px;}
      .header-title-2{font-size:1.01rem;min-height:32px;max-height:32px;}
      .header-epnum{font-size:.98rem;}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content" id="header-main"></div>
  </header>
  <main>
    <div class="box"><div id="app"></div></div>
  </main>
  <footer>
    <small>© 2018–2025 <a href="https://weep.jp/" target="_blank">weepjp</a> (<a href="https://github.com/weepjp/weepjp.github.io" target="_blank">src</a>)</small>
    <div id="version"></div>
  </footer>
  <script>
    const VERSION='v2025.09.16-08';
    document.getElementById('version').textContent=VERSION;
    const JSON_URL="l.json", BASE_TXT_URL="https://filedn.com/lM2herF7FW9HLFywwtY32pX/weepjp/text/";
    let novels=[],currentNovel=null,currentEpId=null;

    function setTitle(t,e){document.title=t&&e?`weep.me text | ${t} | ${e}話`:t?`weep.me text | ${t}`:"weep.me text";}

    function setHeader(nv,epId){
      const h=document.getElementById('header-main');
      // トップページ
      if(!nv){
        h.innerHTML = `<div class="header-title-5">weep.me text</div>`;
        return;
      }
      // 目次（話番号なし）
      if(nv && !epId){
        h.innerHTML = `<div class="header-title-5">${nv.title}</div>`;
        return;
      }
      // 本文（話番号あり）
      let html = `<div class="header-title-2">${nv.title}</div>`;
      html += `<div class="header-epnum">${epId}話</div>`;
      let e=parseInt(epId,10),m=nv.max,
        p=e>1?(e-1+"").padStart(4,"0"):0,
        n=e<m?((e+1)+"").padStart(4,"0"):0;
      html += `<div class="nav-row">`
        +(p?`<button class="nav-btn" onclick="location.hash='#${nv.id}/${p}'">前へ</button>`:`<span class="nav-btn" style="opacity:.35;cursor:default;" tabindex="-1">前へ</span>`)
        +`<span style="margin:0 8px;">|</span>`
        +`<button class="nav-btn" onclick="location.hash='#${nv.id}'">目次</button>`
        +`<span style="margin:0 8px;">|</span>`
        +(n?`<button class="nav-btn" onclick="location.hash='#${nv.id}/${n}'">次へ</button>`:`<span class="nav-btn" style="opacity:.35;cursor:default;" tabindex="-1">次へ</span>`)
        +`</div>`;
      h.innerHTML=html;
    }

    function renderApp(){
      let h=location.hash.replace(/^#/,""),nid="",eid="";
      if(h){let m=h.match(/^([0-9a-zA-Z\-]+)(?:\/(\d{4}))?$/);if(m){nid=m[1]||"";eid=m[2]||"";}}
      if(!novels.length){
        showLoading();
        fetch(JSON_URL+"?t="+Date.now())
          .then(res=>res.json())
          .then(data=>{novels=data;showNovelList();if(nid)showEpList(nid,eid);})
          .catch(()=>showError("作品リストの取得に失敗しました"));
      }else{
        showNovelList();
        if(nid)showEpList(nid,eid);
      }
      if(!nid){setTitle();setHeader();}
    }
    function showNovelList(){
      currentNovel=null;currentEpId=null;
      const app=document.getElementById("app");
      setHeader();
      let html=`<div class="container">`;
      novels.forEach(nv=>{
        html+=`<div class="link" data-id="${nv.id}" tabindex="0" title="${nv.title}">
          <img src="${nv.icon}" alt="${nv.title}">
          <div class="title">${nv.title}</div>
          <div class="subtitle">${nv.desc||""}</div>
          <div style="font-size:.7em;color:#555;">${nv.max}話</div>
        </div>`;
      });
      html+=`</div>`;
      app.innerHTML=html;
      app.querySelectorAll('.link').forEach(el=>{
        el.onclick=()=>{location.hash="#"+el.dataset.id;}
        el.onkeydown=e=>{if(e.key==="Enter"||e.key===" "){el.click();}}
      });
    }
    function showEpList(nid,selEpId){
      const nv=novels.find(n=>n.id==nid);
      if(!nv)return showNovelList();
      currentNovel=nv;currentEpId=null;
      setTitle(nv.title);setHeader(nv);
      const app=document.getElementById("app");
      let html=`<div class="back-row"><button class="back-btn" onclick="location.hash=''"><span class="arrow">&#8592;</span>作品一覧に戻る</button></div>`;
      html+=`<div class="novel-desc">${nv.desc||""}</div><div class="ep-list">`;
      for(let i=1;i<=nv.max;i++){
        let eid=i.toString().padStart(4,"0");
        html+=`<button class="ep-link${eid===selEpId?" selected":""}" data-ep="${eid}">${eid}</button>`;
      }
      html+=`</div>`;
      app.innerHTML=html;
      app.querySelectorAll(".ep-link").forEach(btn=>{
        btn.onclick=()=>{location.hash=`#${nid}/${btn.dataset.ep}`;}
      });
      if(selEpId)showEpisode(nid,selEpId);
    }
    function showEpisode(nid,eid){
      const nv=novels.find(n=>n.id==nid);
      if(!nv)return;
      setTitle(nv.title,eid);setHeader(nv,eid);currentEpId=eid;
      const app=document.getElementById("app");
      app.innerHTML=`<div id="novelView" class="novel-area">読込中...</div>`;
      fetch(`${BASE_TXT_URL}${nid}/${eid}.txt?t=`+Date.now())
        .then(res=>res.ok?res.text():Promise.reject())
        .then(text=>{
          let lines=text.replace(/\r\n?/g,'\n').split('\n'),h="",b=[];
          for(const l of lines){
            if(l.trim()===''){if(b.length){h+=`<p>${escapeHtml(b.join('\n'))}</p>`;b=[];}}
            else{b.push(l);}
          }
          if(b.length)h+=`<p>${escapeHtml(b.join('\n'))}</p>`;
          document.getElementById("novelView").innerHTML=h;
          window.scrollTo({top:0});
        })
        .catch(()=>document.getElementById("novelView").innerHTML="<span style='color:#c00'>本文の取得に失敗しました</span>");
    }
    function showLoading(){document.getElementById("app").innerHTML=`<div class="message">Now loading…</div>`;}
    function showError(msg){document.getElementById("app").innerHTML=`<div class="message" style="color:#c00">${msg}</div>`;}
    function escapeHtml(str){return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}
    window.addEventListener("hashchange",renderApp);renderApp();
  </script>
</body>
</html>
